# deploy_lambda.py

This script publishes a Lambda function to AWS and updates its versioned ARN in SSM Parameter Store. It is the standard way to deploy Lambda functions from the `karma` repo into an Adage-managed infrastructure.

---

## What It Does

- Packages the Lambda function and dependencies into a ZIP
- Uploads the ZIP to AWS Lambda
- Publishes a new version
- Writes the versioned ARN to:

  ```
  /iac/lambda/<nickname>/runtime
  ```

This makes the Lambda resolvable by nickname across environments.

---

## Usage

From the root of the `karma` repository:

```bash
python scripts/deploy_lambda.py log-handler
```

This will:

1. Package Python files and `requirements.txt` (if present)
2. Upload `dist/log-handler.zip` to AWS Lambda
3. Publish a new version
4. Write the resulting versioned ARN to:

   ```
   /iac/lambda/log-handler/runtime
   ```

---

## Lambda Directory Structure

Each Lambda must live under `lambdas/<nickname>/`:

```
lambdas/
└── log-handler/
    ├── main.py
    ├── requirements.txt     # optional
    └── dist/
        └── log-handler.zip  # auto-generated by deploy_lambda
```

---

## Shared Build Logic

The script:

- Recursively includes all `.py` files in the Lambda directory
- Installs any dependencies from `requirements.txt` into the build
- Packages everything into a ZIP in `dist/`

---

## After Publishing

Once published, other components like `serverless-rest` will resolve the Lambda version using:

```json
{
  "arn": "arn:aws:lambda:us-east-1:123456789012:function:log-handler:3"
}
```

from:

```
/iac/lambda/log-handler/runtime
```

---

## Notes

- The Lambda function must already exist in AWS — create it via Terraform or manually
- AWS credentials must be available via `AWS_PROFILE`, `~/.aws/credentials`, or environment variables
- This script is safe to run repeatedly and is version-aware
- Lambdas can be published independently from any branch — useful for testing, staging, and hotfixes
